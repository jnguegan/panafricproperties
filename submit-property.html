<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Submit Property ‚Äî PanAfric Properties</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ‚úÖ Add favicon (and use absolute paths so nested routes never break) -->
  <link rel="icon" href="/favicon.ico" sizes="any">
  <link rel="icon" type="image/png" href="/favicon.png">

  <link rel="stylesheet" href="styles.css">
</head>
<body>

<!-- ‚úÖ AUTH0 GUARD -->
<script src="https://cdn.auth0.com/js/auth0/9.23/auth0.min.js"></script>
<script src="auth.js"></script>
<script>
  authHandleRedirect(function () {
    authRequireLogin();
  });
</script>

<!-- üåç Language Dropdown -->
<div class="lang-switch">
  <span class="lang-label" data-i18n="lang.label">Language</span>
  <select class="lang-select" aria-label="Language" onchange="papSetLang(this.value)">
    <option value="en">EN</option>
    <option value="fr">FR</option>
    <option value="es">ES</option>
  </select>
</div>

<section class="section">
  <div class="wrap">

    <a class="btn ghost" href="partner-dashboard.html" data-i18n="submit.back">‚Üê Back to Dashboard</a>

    <div class="card" style="padding:18px; margin-top:12px;">
      <h2 style="margin:0 0 6px;" data-i18n="submit.title">Submit a Property</h2>
      <p class="small" style="margin:0; opacity:.85;" data-i18n="submit.subtitle">
        Submit a property for review. Once approved, it can be published on PanAfric Properties.
      </p>

      <div class="card" id="blockedBox" style="margin-top:14px; padding:16px; display:none;">
        <p class="small" style="margin:0;" data-i18n="submit.blocked">
          You must complete the Partner Academy to submit properties.
        </p>
        <div style="margin-top:12px;">
          <a class="btn green" href="academy.html" data-i18n="submit.go_academy">Go to Academy</a>
        </div>
      </div>

      <!-- ‚úÖ SUBMIT TO NETLIFY FUNCTION (Supabase live publish) -->
      <form
        style="margin-top:14px;"
        id="propertyForm"
      >
        <!-- Partner identity (auto-filled) -->
        <div class="grid" style="margin-top:10px;">
          <div class="card" style="padding:14px;">
            <label class="small" data-i18n="submit.partner_name">Partner full name</label>
            <input class="input" type="text" name="partner_name" id="partner_name" required>
          </div>
          <div class="card" style="padding:14px;">
            <label class="small" data-i18n="submit.partner_email">Partner email</label>
            <input class="input" type="email" name="partner_email" id="partner_email" required>
          </div>
        </div>

        <!-- Core fields -->
        <div class="grid" style="margin-top:10px;">
          <div class="card" style="padding:14px;">
            <label class="small" data-i18n="submit.listing_title">Listing title</label>
            <input class="input" type="text" name="listing_title" required>
          </div>

          <div class="card" style="padding:14px;">
            <label class="small" data-i18n="submit.property_type">Property type</label>
            <select class="input" name="property_type" required>
              <option value="" data-i18n="submit.select">Select‚Ä¶</option>
              <option value="land" data-i18n="submit.type.land">Land</option>
              <option value="house" data-i18n="submit.type.house">House</option>
              <option value="apartment" data-i18n="submit.type.apartment">Apartment</option>
              <option value="commercial" data-i18n="submit.type.commercial">Commercial</option>
              <option value="development" data-i18n="submit.type.development">Development project</option>
            </select>
          </div>

          <div class="card" style="padding:14px;">
            <label class="small" data-i18n="submit.country">Country</label>
            <input class="input" type="text" name="country" required>
          </div>

          <div class="card" style="padding:14px;">
            <label class="small" data-i18n="submit.city">City / Area</label>
            <input class="input" type="text" name="city_area" required>
          </div>

          <!-- ‚úÖ NEW: Address -->
          <div class="card" style="padding:14px;">
            <label class="small" data-i18n="submit.address">Address</label>
            <input class="input" type="text" name="address" placeholder="Street / District (optional)">
          </div>

          <!-- ‚úÖ NEW: Size (m¬≤) -->
          <div class="card" style="padding:14px;">
            <label class="small" data-i18n="submit.size_m2">Size (m¬≤)</label>
            <input class="input" type="number" name="size_m2" min="0" step="1" placeholder="e.g. 120">
          </div>

          <!-- ‚úÖ NEW: Bedrooms -->
          <div class="card" style="padding:14px;">
            <label class="small" data-i18n="submit.bedrooms">Bedrooms</label>
            <input class="input" type="number" name="bedrooms" min="0" step="1" placeholder="e.g. 3">
          </div>

          <!-- ‚úÖ NEW: Bathrooms -->
          <div class="card" style="padding:14px;">
            <label class="small" data-i18n="submit.bathrooms">Bathrooms</label>
            <input class="input" type="number" name="bathrooms" min="0" step="1" placeholder="e.g. 2">
          </div>

          <div class="card" style="padding:14px;">
            <label class="small" data-i18n="submit.price">Price</label>
            <input class="input" type="number" name="price" min="0" step="0.01" required>
          </div>

          <div class="card" style="padding:14px;">
            <label class="small" data-i18n="submit.currency">Currency</label>
            <select class="input" name="currency" required>
              <option value="EUR">EUR</option>
              <option value="USD">USD</option>
              <option value="GBP">GBP</option>
              <option value="XOF">XOF</option>
              <option value="XAF">XAF</option>
            </select>
          </div>
        </div>

        <!-- Description -->
        <div class="card" style="padding:14px; margin-top:10px;">
          <label class="small" data-i18n="submit.description">Description</label>
          <textarea class="input" name="description" rows="7" required></textarea>
          <p class="small" style="margin:8px 0 0; opacity:.75;" data-i18n="submit.description_note">
            Include size, condition, ownership status, nearby landmarks, and any restrictions.
          </p>
        </div>

        <!-- Media uploads -->
        <div class="grid" style="margin-top:10px;">
          <div class="card" style="padding:14px;">
            <label class="small" data-i18n="submit.photos">Photos (up to 10)</label>
            <!-- IMPORTANT: Netlify function expects "photos" field name -->
            <input class="input" type="file" name="photos" id="photos" accept="image/*" multiple>
            <p class="small" style="margin:8px 0 0; opacity:.75;" data-i18n="submit.photos_note">
              JPG/PNG recommended. Clear exterior + interior + land boundaries.
            </p>
          </div>

          <div class="card" style="padding:14px;">
            <label class="small" data-i18n="submit.docs">Ownership documents (optional)</label>
            <input class="input" type="file" name="documents" id="documents" multiple>
            <p class="small" style="margin:8px 0 0; opacity:.75;" data-i18n="submit.docs_note">
              Title deed, land certificate, or any proof of authority to list.
            </p>
          </div>
        </div>

        <!-- Contact -->
        <div class="grid" style="margin-top:10px;">
          <div class="card" style="padding:14px;">
            <label class="small" data-i18n="submit.contact_phone">Contact phone (optional)</label>
            <input class="input" type="text" name="contact_phone">
          </div>

          <div class="card" style="padding:14px;">
            <label class="small" data-i18n="submit.contact_whatsapp">WhatsApp (optional)</label>
            <input class="input" type="text" name="contact_whatsapp">
          </div>
        </div>

        <!-- Consent -->
        <div class="card" style="padding:14px; margin-top:10px;">
          <label style="display:flex; gap:10px; align-items:flex-start;">
            <input type="checkbox" name="consent" required style="margin-top:4px;">
            <span class="small" data-i18n="submit.consent">
              I confirm I have the right to submit this property and the information is accurate.
            </span>
          </label>
        </div>

        <!-- Submit -->
        <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
          <button class="btn green" type="submit" id="submitBtn" data-i18n="submit.cta.submit">Submit for review</button>
          <a class="btn ghost" href="partner-dashboard.html" data-i18n="submit.cta.cancel">Cancel</a>
          <span id="submitSpinner" class="small" style="display:none; opacity:.8;">Submitting‚Ä¶</span>
        </div>

        <div id="msgOk" class="card" style="margin-top:12px; padding:14px; display:none;"></div>
        <div id="msgErr" class="card" style="margin-top:12px; padding:14px; display:none;"></div>

        <p class="small" style="margin-top:10px; opacity:.75;" data-i18n="submit.footer_note">
          After submission, our team will review and contact you if clarifications are needed.
        </p>
      </form>

    </div>

  </div>
</section>

<script src="/assets/js/i18n.js"></script>
<script>
  (function(){
    if (typeof window.papApplyI18n === "function") window.papApplyI18n();

    const certified = (localStorage.getItem("papAcademyCompleted") === "1");
    const form = document.getElementById("propertyForm");
    const blocked = document.getElementById("blockedBox");

    if (!certified) {
      if (blocked) blocked.style.display = "block";
      if (form) form.style.display = "none";
      return;
    }

    const user = (typeof window.authGetUser === "function" ? window.authGetUser() : null) || {};
    const email = (user.email || "").trim();

    const storedName =
      (localStorage.getItem("pap_partner_fullname") || "").trim() ||
      (user.name || "").trim() ||
      (user.nickname || "").trim();

    const nameInput = document.getElementById("partner_name");
    const emailInput = document.getElementById("partner_email");

    if (nameInput && storedName) nameInput.value = storedName;
    if (emailInput && email) emailInput.value = email;

    const submitBtn = document.getElementById("submitBtn");
    const spinner = document.getElementById("submitSpinner");
    const okBox = document.getElementById("msgOk");
    const errBox = document.getElementById("msgErr");

    function showOk(html){
      if (errBox) errBox.style.display = "none";
      if (okBox){
        okBox.style.display = "block";
        okBox.innerHTML = html;
      }
    }
    function showErr(text){
      if (okBox) okBox.style.display = "none";
      if (errBox){
        errBox.style.display = "block";
        errBox.textContent = text || "Something went wrong.";
      }
    }

    // Helper: only send numeric fields if valid
    function normalizeNumber(v){
      const n = Number(String(v ?? '').trim());
      return Number.isFinite(n) ? String(n) : '';
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (okBox) okBox.style.display = "none";
      if (errBox) errBox.style.display = "none";

      if (!form.checkValidity()){
        form.reportValidity();
        return;
      }

      submitBtn.disabled = true;
      if (spinner) spinner.style.display = "inline";

      try{
        const fd = new FormData(form);

        // ‚úÖ TITLE FIX: also send "title" so Supabase/Function can store correctly
        const lt = (fd.get("listing_title") || "").toString().trim();
        if (lt) fd.set("title", lt);

        // ‚úÖ Ensure new fields are present and clean
        const address = (fd.get("address") || "").toString().trim();
        if (address) fd.set("address", address);

        const size = normalizeNumber(fd.get("size_m2"));
        if (size) fd.set("size_m2", size); else fd.delete("size_m2");

        const beds = normalizeNumber(fd.get("bedrooms"));
        if (beds) fd.set("bedrooms", beds); else fd.delete("bedrooms");

        const baths = normalizeNumber(fd.get("bathrooms"));
        if (baths) fd.set("bathrooms", baths); else fd.delete("bathrooms");

        // Ensure we are not sending Netlify form fields; function expects raw fields + files
        fd.delete("form-name");

        const res = await fetch("/.netlify/functions/submitProperty", {
          method: "POST",
          body: fd
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok || data.ok === false){
          throw new Error(data.error || `Submit failed (${res.status})`);
        }

        const id = data.id;
        const url = data.url || (id ? `/properties/${encodeURIComponent(id)}` : "properties.html");

        const keepName = nameInput ? nameInput.value : "";
        const keepEmail = emailInput ? emailInput.value : "";
        form.reset();
        if (nameInput) nameInput.value = keepName;
        if (emailInput) emailInput.value = keepEmail;

        showOk(
          `<strong>Published ‚úÖ</strong><br><br>
           <a class="btn green" href="${url}">View listing</a>
           <a class="btn ghost" style="margin-left:8px" href="properties.html">Go to Properties</a>`
        );

      }catch(err){
        showErr(err && err.message ? err.message : "Submit failed.");
      }finally{
        submitBtn.disabled = false;
        if (spinner) spinner.style.display = "none";
      }
    });

  })();
</script>

</body>
</html>

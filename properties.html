<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title data-i18n="properties.pageTitle">Properties — PanAfric Properties</title>
  <meta name="description" content="Browse approved property listings." />

  <link rel="icon" href="favicon.ico" sizes="any">
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="stylesheet" href="styles.css">
</head>

<body data-page="properties">
  <!-- Header (kept intentionally simple + compatible with your existing styling) -->
  <header class="header">
    <div class="wrap">
      <div class="navbar">
        <a class="brand" href="index.html" style="text-decoration:none;">
          <strong>PanAfric Properties</strong>
        </a>

        <div class="lang" style="display:flex; gap:10px; align-items:center;">
          <label for="langSelect" class="small" data-i18n="lang_label">Language</label>
          <select id="langSelect" aria-label="Language">
            <option value="en">EN</option>
            <option value="fr">FR</option>
            <option value="es">ES</option>
          </select>
        </div>
      </div>
    </div>
  </header>

  <main>
    <section class="section">
      <div class="wrap">
        <h1 data-i18n="properties.h1">Approved Property Listings</h1>
        <p class="small" data-i18n="properties.intro">
          Browse approved listings. Each property is reviewed before publication.
        </p>

        <div class="card" style="padding:16px; margin-top:16px;">
          <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:center;">
            <input id="searchInput" type="search" class="input" style="flex:1; min-width:240px;"
                   placeholder="Search by city, country, or keyword" data-i18n-placeholder="properties.searchPlaceholder" />

            <select id="categoryFilter" class="input" style="min-width:180px;">
              <option value="" data-i18n="properties.filterAll">All categories</option>
              <option value="sale" data-i18n="properties.filterSale">For sale</option>
              <option value="rent" data-i18n="properties.filterRent">For rent</option>
            </select>

            <select id="typeFilter" class="input" style="min-width:180px;">
              <option value="" data-i18n="properties.typeAll">All types</option>
              <option value="apartment" data-i18n="properties.typeApartment">Apartment</option>
              <option value="house" data-i18n="properties.typeHouse">House</option>
              <option value="land" data-i18n="properties.typeLand">Land</option>
              <option value="commercial" data-i18n="properties.typeCommercial">Commercial</option>
            </select>
          </div>

          <div class="small" id="resultsMeta" style="margin-top:10px;"></div>
        </div>

        <div id="listingsGrid" class="grid" style="margin-top:16px;"></div>

        <div id="emptyState" class="card" style="padding:18px; margin-top:16px; display:none;">
          <h3 style="margin:0 0 6px;" data-i18n="properties.emptyTitle">No approved listings yet</h3>
          <p class="small" style="margin:0;" data-i18n="properties.emptyText">
            Please check back soon. New listings are published after admin approval.
          </p>
        </div>

        <div id="errorState" class="card" style="padding:18px; margin-top:16px; display:none;">
          <h3 style="margin:0 0 6px;" data-i18n="properties.errorTitle">Unable to load listings</h3>
          <p class="small" style="margin:0;" data-i18n="properties.errorText">
            Please try again later.
          </p>
        </div>

      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="wrap small">
      <span>© <span id="year"></span> PanAfric Properties</span>
    </div>
  </footer>

  <!-- i18n + page logic -->
  <script src="assets/js/i18n.js"></script>
  <script>
    (function(){
      // Footer year
      document.getElementById('year').textContent = new Date().getFullYear();

      // Hook into your existing language system safely
      const langSelect = document.getElementById('langSelect');
      const saved = (localStorage.getItem('pap_lang') || localStorage.getItem('lang') || 'en').toLowerCase();
      if (['en','fr','es'].includes(saved)) langSelect.value = saved;

      function applyLang(lang){
        try {
          if (typeof papSetLang === 'function') papSetLang(lang);
          else localStorage.setItem('pap_lang', lang);
        } catch(e) {}
      }

      langSelect.addEventListener('change', () => applyLang(langSelect.value));
      applyLang(langSelect.value);
    })();
  </script>

  <script>
    (function(){
      const grid = document.getElementById('listingsGrid');
      const emptyState = document.getElementById('emptyState');
      const errorState = document.getElementById('errorState');
      const resultsMeta = document.getElementById('resultsMeta');

      const searchInput = document.getElementById('searchInput');
      const categoryFilter = document.getElementById('categoryFilter');
      const typeFilter = document.getElementById('typeFilter');

      // ✅ Supabase public config (anon only; never use service role in browser)
      const SUPABASE_URL = "https://ogyhfjdrqcupwesnjoly.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9neWhmamRycWN1cHdlc25qb2x5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzMzk3MzcsImV4cCI6MjA4NjkxNTczN30.rMf9nGeN2DxjSjzUAC4agcXEnsliiZWnTMOoV6qMsAo";

      const REST = `${SUPABASE_URL}/rest/v1/listings`;
      const headers = {
        "apikey": SUPABASE_ANON_KEY,
        "Authorization": `Bearer ${SUPABASE_ANON_KEY}`
      };

      let all = [];

      function escapeHtml(str){
        return String(str ?? '').replace(/[&<>"']/g, s => ({
          '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
        }[s]));
      }

      function money(price, currency){
        const v = Number(price);
        if (!Number.isFinite(v)) return '';
        const c = (currency || 'EUR').toUpperCase();
        try {
          return new Intl.NumberFormat(undefined, { style:'currency', currency:c, maximumFractionDigits:0 }).format(v);
        } catch(e){
          return `${v.toLocaleString()} ${c}`;
        }
      }

      function normalize(s){ return String(s ?? '').toLowerCase().trim(); }

      function parseImages(item){
        // Supports: images as array, JSON string array, or single URL string
        const v = item.images;
        if (Array.isArray(v)) return v;
        if (typeof v === 'string' && v.trim()){
          try {
            const arr = JSON.parse(v);
            if (Array.isArray(arr)) return arr;
          } catch(e){}
          return [v];
        }
        return [];
      }

      function listingUrl(id){
        // ✅ clean URL; requires Netlify redirect: /properties/* /property.html 200
        return `/properties/${encodeURIComponent(id)}`;
      }

      function buildCard(item){
        const imgs = parseImages(item);
        const img = item.cover_url || (imgs.length ? imgs[0] : '');
        const title = escapeHtml(item.title || item.listing_title || '');
        const loc = [item.city, item.country].filter(Boolean).join(', ');
        const price = money(item.price, item.currency);

        const bed = Number.isFinite(Number(item.bedrooms)) ? `${item.bedrooms} bd` : '';
        const bath = Number.isFinite(Number(item.bathrooms)) ? `${item.bathrooms} ba` : '';
        const size = Number.isFinite(Number(item.sizeM2)) ? `${item.sizeM2} m²` : '';
        const metaBits = [bed, bath, size].filter(Boolean).join(' · ');

        const link = listingUrl(item.id);

        const badge = escapeHtml((item.category || '').toLowerCase());
        const badgeLabel = badge === 'rent'
          ? (document.querySelector('[data-i18n="properties.badgeRent"]')?.textContent || 'For rent')
          : (document.querySelector('[data-i18n="properties.badgeSale"]')?.textContent || 'For sale');

        return `
          <article class="card" style="overflow:hidden;">
            ${img ? `
              <a href="${link}" style="display:block;">
                <img src="${escapeHtml(img)}" alt="${title}" style="width:100%; height:200px; object-fit:cover; display:block;">
              </a>
            ` : ''}
            <div style="padding:14px;">
              <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">
                <h3 style="margin:0;">
                  <a href="${link}" style="text-decoration:none;">${title}</a>
                </h3>
                <span class="small" style="white-space:nowrap; opacity:.9;">${escapeHtml(badgeLabel)}</span>
              </div>

              <p class="small" style="margin:6px 0 0;">${escapeHtml(loc)}</p>

              <div style="display:flex; justify-content:space-between; gap:10px; align-items:center; margin-top:10px;">
                <strong>${escapeHtml(price)}</strong>
                <span class="small">${escapeHtml(metaBits)}</span>
              </div>

              <div style="margin-top:12px;">
                <a class="btn" href="${link}" data-i18n="properties.viewBtn">View details</a>
              </div>
            </div>
          </article>
        `;
      }

      function render(list){
        grid.innerHTML = '';
        errorState.style.display = 'none';

        if (!list.length){
          emptyState.style.display = 'block';
          resultsMeta.textContent = '';
          return;
        }
        emptyState.style.display = 'none';

        grid.innerHTML = list.map(buildCard).join('');
        resultsMeta.textContent = `${list.length} / ${all.length}`;

        // Re-apply i18n if your system needs it after injecting HTML
        try { if (typeof papApplyI18n === 'function') papApplyI18n(); } catch(e){}
      }

      function applyFilters(){
        const q = normalize(searchInput.value);
        const cat = normalize(categoryFilter.value);
        const type = normalize(typeFilter.value);

        const filtered = all.filter(p => {
          // ✅ only show published/approved rows
          const st = normalize(p.status);
          const ok = (st === 'approved' || st === 'published' || st === 'live' || st === '');
          if (!ok) return false;

          if (cat && normalize(p.category) !== cat) return false;

          // Support both "propertyType" and "property_type" and "type"
          const pt = normalize(p.propertyType || p.property_type || p.type);
          if (type && pt !== type) return false;

          if (!q) return true;
          const hay = [
            p.title, p.listing_title, p.description, p.country, p.city, p.areaLabel, p.address,
            (Array.isArray(p.features) ? p.features : []).join(' ')
          ].join(' ');
          return normalize(hay).includes(q);
        });

        render(filtered);
      }

      async function load(){
        try{
          // Adjust select list to match your Supabase schema (safe to include extra columns)
          const select = [
            "id","title","listing_title",
            "status","category",
            "type","propertyType","property_type",
            "country","city","price","currency",
            "bedrooms","bathrooms","sizeM2",
            "description","images","cover_url",
            "created_at"
          ].join(',');

          const url = `${REST}?select=${encodeURIComponent(select)}&order=created_at.desc`;

          const res = await fetch(url, { headers });
          if (!res.ok) throw new Error('HTTP ' + res.status);

          const data = await res.json();
          all = Array.isArray(data) ? data : [];
          applyFilters();

        } catch(e){
          console.error(e);
          grid.innerHTML = '';
          emptyState.style.display = 'none';
          errorState.style.display = 'block';
          resultsMeta.textContent = '';
        }
      }

      // Wire events
      searchInput.addEventListener('input', applyFilters);
      categoryFilter.addEventListener('change', applyFilters);
      typeFilter.addEventListener('change', applyFilters);

      load();
    })();
  </script>
</body>
</html>

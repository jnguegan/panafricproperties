<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title data-i18n="properties.pageTitle">Properties — PanAfric Properties</title>
  <meta name="description" content="Browse approved property listings." />

  <!-- ✅ absolute favicon paths -->
  <link rel="icon" href="/favicon.ico" sizes="any">
  <link rel="icon" type="image/png" href="/favicon.png">

  <link rel="stylesheet" href="styles.css">

  <style>
    .papCardMedia{
      width:100%;
      height:200px;
      object-fit:cover;
      display:block;
    }
    .papTitleClamp{
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
      line-height:1.2;
    }
    .papBadges{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:flex-start;
    }
    .papPill{
      display:inline-block;
      padding:3px 10px;
      border-radius:999px;
      background: rgba(0,0,0,.06);
      font-weight:700;
      white-space:nowrap;
    }
  </style>
</head>

<body data-page="properties">
  <header class="header">
    <div class="wrap">
      <div class="navbar">
        <a class="brand" href="index.html" style="text-decoration:none;">
          <strong>PanAfric Properties</strong>
        </a>

        <div class="lang" style="display:flex; gap:10px; align-items:center;">
          <label for="langSelect" class="small" data-i18n="lang_label">Language</label>
          <select id="langSelect" aria-label="Language">
            <option value="en">EN</option>
            <option value="fr">FR</option>
            <option value="es">ES</option>
          </select>
        </div>
      </div>
    </div>
  </header>

  <main>
    <section class="section">
      <div class="wrap">
        <h1 data-i18n="properties.h1">Approved Property Listings</h1>
        <p class="small" data-i18n="properties.intro">
          Browse approved listings. Each property is reviewed before publication.
        </p>

        <div class="card" style="padding:16px; margin-top:16px;">
          <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:center;">
            <input id="searchInput" type="search" class="input" style="flex:1; min-width:240px;"
                   placeholder="Search by city, country, or keyword" data-i18n-placeholder="properties.searchPlaceholder" />

            <select id="categoryFilter" class="input" style="min-width:180px;">
              <option value="" data-i18n="properties.filterAll">All categories</option>
              <option value="sale" data-i18n="properties.filterSale">For sale</option>
              <option value="rent" data-i18n="properties.filterRent">For rent</option>
            </select>

            <select id="typeFilter" class="input" style="min-width:180px;">
              <option value="" data-i18n="properties.typeAll">All types</option>
              <option value="apartment" data-i18n="properties.typeApartment">Apartment</option>
              <option value="house" data-i18n="properties.typeHouse">House</option>
              <option value="land" data-i18n="properties.typeLand">Land</option>
              <option value="commercial" data-i18n="properties.typeCommercial">Commercial</option>
            </select>
          </div>

          <div class="small" id="resultsMeta" style="margin-top:10px;"></div>
        </div>

        <div id="listingsGrid" class="grid" style="margin-top:16px;"></div>

        <div id="emptyState" class="card" style="padding:18px; margin-top:16px; display:none;">
          <h3 style="margin:0 0 6px;" data-i18n="properties.emptyTitle">No approved listings yet</h3>
          <p class="small" style="margin:0;" data-i18n="properties.emptyText">
            Please check back soon. New listings are published after admin approval.
          </p>
        </div>

        <div id="errorState" class="card" style="padding:18px; margin-top:16px; display:none;">
          <h3 style="margin:0 0 6px;" data-i18n="properties.errorTitle">Unable to load listings</h3>
          <p class="small" style="margin:0;" data-i18n="properties.errorText">
            Please try again later.
          </p>
        </div>

      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="wrap small">
      <span>© <span id="year"></span> PanAfric Properties</span>
    </div>
  </footer>

  <script src="/assets/js/i18n.js"></script>

  <script>
    (function(){
      document.getElementById('year').textContent = new Date().getFullYear();

      const langSelect = document.getElementById('langSelect');
      const saved = (localStorage.getItem('pap_lang') || localStorage.getItem('lang') || 'en').toLowerCase();
      if (['en','fr','es'].includes(saved)) langSelect.value = saved;

      function applyLang(lang){
        try {
          if (typeof papSetLang === 'function') papSetLang(lang);
          else localStorage.setItem('pap_lang', lang);
        } catch(e) {}
      }

      langSelect.addEventListener('change', () => applyLang(langSelect.value));
      applyLang(langSelect.value);
    })();
  </script>

  <script>
    (function(){
      const grid = document.getElementById('listingsGrid');
      const emptyState = document.getElementById('emptyState');
      const errorState = document.getElementById('errorState');
      const resultsMeta = document.getElementById('resultsMeta');

      const searchInput = document.getElementById('searchInput');
      const categoryFilter = document.getElementById('categoryFilter');
      const typeFilter = document.getElementById('typeFilter');

      const SUPABASE_URL = "https://ogyhfjdrqcupwesnjoly.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9neWhmamRycWN1cHdlc25qb2x5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzMzk3MzcsImV4cCI6MjA4NjkxNTczN30.rMf9nGeN2DxjSjzUAC4agcXEnsliiZWnTMOoV6qMsAo";

      const REST = `${SUPABASE_URL}/rest/v1/listings`;
      const headers = {
        "apikey": SUPABASE_ANON_KEY,
        "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
        "Accept": "application/json"
      };

      let all = [];

      function escapeHtml(str){
        return String(str ?? '').replace(/[&<>"']/g, s => ({
          '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
        }[s]));
      }

      function money(price, currency){
        const v = Number(price);
        if (!Number.isFinite(v)) return '';
        const c = (currency || 'EUR').toUpperCase();
        try {
          return new Intl.NumberFormat(undefined, { style:'currency', currency:c, maximumFractionDigits:0 }).format(v);
        } catch(e){
          return `${v.toLocaleString()} ${c}`;
        }
      }

      function normalize(s){ return String(s ?? '').toLowerCase().trim(); }

      function parseImages(item){
        const v = item.images;
        if (Array.isArray(v)) return v;
        if (typeof v === 'string' && v.trim()){
          try {
            const arr = JSON.parse(v);
            if (Array.isArray(arr)) return arr;
          } catch(e){}
          return [v];
        }
        return [];
      }

      function listingUrl(id){
        return `/properties/${encodeURIComponent(id)}`;
      }

      function getTitle(item){
        return (item.title || item.listing_title || '').toString().trim() || 'Untitled';
      }

      function statusLabel(st){
        const s = normalize(st);
        if (s === 'sold') return (document.querySelector('[data-i18n="properties.badgeSold"]')?.textContent || 'Sold');
        if (s === 'under_offer') return (document.querySelector('[data-i18n="properties.badgeUnderOffer"]')?.textContent || 'Under offer');
        return '';
      }

      function categoryLabel(cat){
        const c = normalize(cat);
        return c === 'rent'
          ? (document.querySelector('[data-i18n="properties.badgeRent"]')?.textContent || 'For rent')
          : (document.querySelector('[data-i18n="properties.badgeSale"]')?.textContent || 'For sale');
      }

      function buildCard(item){
        const imgs = parseImages(item);
        const img = item.cover_url || (imgs.length ? imgs[0] : '');
        const safeTitle = escapeHtml(getTitle(item));
        const loc = [item.city, item.country].filter(Boolean).join(', ');
        const price = money(item.price, item.currency);

        const link = listingUrl(item.id);

        const st = statusLabel(item.status);
const cat = categoryLabel(item.category);
const isSpecial = normalize(item.status) === 'sold' || normalize(item.status) === 'under_offer';

return `
  <article class="card" style="overflow:hidden;">
    ${img ? `
      <a href="${link}" style="display:block;">
        <img class="papCardMedia" src="${escapeHtml(img)}" alt="${safeTitle}" loading="lazy">
      </a>
    ` : ''}
    <div style="padding:14px;">
      <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">
        <h3 class="papTitleClamp" style="margin:0;">
          <a href="${link}" style="text-decoration:none;">${safeTitle}</a>
        </h3>

        <div class="papBadges small" style="opacity:.95;">
          ${st ? `<span class="papPill">${escapeHtml(st)}</span>` : ``}
          ${isSpecial ? `` : `<span class="papPill">${escapeHtml(cat)}</span>`}
        </div>

      </div>


              <p class="small" style="margin:6px 0 0;">${escapeHtml(loc)}</p>

              <div style="margin-top:10px;">
                <strong>${escapeHtml(price)}</strong>
              </div>

              <div style="margin-top:12px;">
                <a class="btn" href="${link}" data-i18n="properties.viewBtn">View details</a>
              </div>
            </div>
          </article>
        `;
      }

      function render(list){
        grid.innerHTML = '';
        errorState.style.display = 'none';

        if (!list.length){
          emptyState.style.display = 'block';
          resultsMeta.textContent = '';
          return;
        }
        emptyState.style.display = 'none';

        grid.innerHTML = list.map(buildCard).join('');
        resultsMeta.textContent = `${list.length} / ${all.length}`;

        try {
          if (typeof papReapplyI18n === 'function') { papReapplyI18n(); setTimeout(papReapplyI18n, 0); }
          else if (typeof papApplyI18n === 'function') { papApplyI18n(); setTimeout(papApplyI18n, 0); }
        } catch(e){}
      }

      function isPublicStatus(st){
        const s = normalize(st);
        return (s === 'approved' || s === 'published' || s === 'live' || s === 'sold' || s === 'under_offer' || s === '');
      }

      function applyFilters(){
        const q = normalize(searchInput.value);
        const cat = normalize(categoryFilter.value);
        const type = normalize(typeFilter.value);

        const filtered = all.filter(p => {
          if (!isPublicStatus(p.status)) return false;

          if (cat && normalize(p.category) !== cat) return false;

          const pt = normalize(p.propertyType || p.property_type || p.type);
          if (type && pt !== type) return false;

          if (!q) return true;
          const hay = [
            p.title, p.listing_title, p.description, p.country, p.city, p.address
          ].join(' ');
          return normalize(hay).includes(q);
        });

        render(filtered);
      }

      async function load(){
        try{
          const url = `${REST}?select=*`;

          const res = await fetch(url, { headers });
          const text = await res.text();

          if (!res.ok){
            console.error("Supabase error:", res.status, text);
            throw new Error('HTTP ' + res.status);
          }

          const data = JSON.parse(text);
          all = Array.isArray(data) ? data : [];
          applyFilters();

        } catch(e){
          console.error(e);
          grid.innerHTML = '';
          emptyState.style.display = 'none';
          errorState.style.display = 'block';
          resultsMeta.textContent = '';
        }
      }

      searchInput.addEventListener('input', applyFilters);
      categoryFilter.addEventListener('change', applyFilters);
      typeFilter.addEventListener('change', applyFilters);

      load();
    })();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Partner Certificate ‚Äî PanAfric Properties</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css">
</head>
<body>

<!-- ‚úÖ AUTH0 GUARD (right after <body>) -->
<script src="https://cdn.auth0.com/js/auth0/9.23/auth0.min.js"></script>
<script src="auth.js"></script>
<script>
  authHandleRedirect(function () {
    authRequireLogin();
  });
</script>

<!-- üåç Language Dropdown -->
<div class="lang-switch">
  <span class="lang-label" data-i18n="lang.label">Language</span>
  <select class="lang-select" aria-label="Language" onchange="papSetLang(this.value)">
    <option value="en">EN</option>
    <option value="fr">FR</option>
    <option value="es">ES</option>
  </select>
</div>

<section class="section">
  <div class="wrap">
    <a class="btn ghost" href="academy.html" data-i18n="cert.back">‚Üê Back to Academy</a>

    <div class="card" id="locked" style="padding:22px 18px; margin-top:12px; display:none;">
      <h2 data-i18n="cert.locked.title">Certificate Locked</h2>
      <p class="small" data-i18n="cert.locked.text">Complete all modules to unlock your Partner Certification.</p>
      <p class="small" id="lockStatus" style="opacity:.85;"></p>
    </div>

    <div class="card" id="cert" style="padding:26px 18px; margin-top:12px; display:none;">
      <div style="text-align:center;">

        <!-- ‚úÖ Logo + Brand -->
        <div style="display:flex; flex-direction:column; align-items:center; gap:10px; margin-bottom:6px;">
          <img
  id="papLogo"
  src="brand/primary_logo.png"
  alt="PanAfric Properties"
  style="width:95px; height:95px; object-fit:contain; margin-bottom:6px;"
>
          <h2 style="margin:0;" data-i18n="cert.brand">PanAfric Properties</h2>
        </div>

        <p class="small" style="margin:0;" data-i18n="cert.program">Training & Certification Program</p>
        <hr style="margin:16px 0; opacity:.2;">
        <h1 style="margin:0 0 8px;" data-i18n="cert.title">Certificate of Completion</h1>
        <p class="small" style="max-width:720px; margin:0 auto;" data-i18n="cert.desc">
          This certifies that the partner named below has successfully completed all training modules
          and assessments under the PanAfric Properties Partner Academy.
        </p>

        <div style="margin-top:18px;">
          <h2 id="partnerName" style="margin:0;"></h2>
          <p class="small" id="partnerEmail" style="margin:6px 0 0;"></p>
          <p class="small" id="certId" style="margin:6px 0 0; opacity:.85;"></p>
          <p class="small" id="certDate" style="margin:6px 0 0; opacity:.85;"></p>
        </div>

        <div style="margin-top:18px;">
          <button class="btn green" onclick="window.print()" data-i18n="cert.cta.print">Print / Save PDF</button>
          <button class="btn ghost" type="button" onclick="authLogout()" style="margin-left:10px;" data-i18n="cert.cta.logout">Log out</button>
        </div>

        <p class="small" style="margin-top:14px; opacity:.8;" data-i18n="cert.note">
          Certification remains active subject to ongoing compliance, ethics, and platform standards.
        </p>
      </div>
    </div>
  </div>
</section>

<!-- ‚úÖ Load translations BEFORE script -->
<script src="assets/js/i18n.js"></script>

<script>
  // ---- Translation helper with fallback (so keys never show) ----
  function tr(key, fallback, vars) {
    let s = fallback;

    try {
      if (typeof window.papT === "function") s = window.papT(key) || fallback;
      else if (typeof window.t === "function") s = window.t(key) || fallback;
      else if (typeof window.papTranslate === "function") s = window.papTranslate(key) || fallback;
      else {
        const lang = localStorage.getItem("pap_lang") || "en";
        const dict = (window.DICT && window.DICT[lang]) ? window.DICT[lang] : null;
        if (dict && dict[key]) s = dict[key];
      }
    } catch (e) {}

    if (vars && typeof s === "string") {
      Object.keys(vars).forEach((k) => {
        const val = vars[k] == null ? "" : String(vars[k]);
        s = s.split(`{${k}}`).join(val);
      });
    }
    return s;
  }

  function getPassedCount() {
    try {
      const arr = JSON.parse(localStorage.getItem("pap_modules_passed") || "[]");
      return Array.isArray(arr) ? arr.length : 0;
    } catch (e) {
      return 0;
    }
  }

  // ‚úÖ Fix logo path if needed (fallback to root logo.png)
  (function () {
    const img = document.getElementById("papLogo");
    if (!img) return;
    img.onerror = function () {
      if (img.dataset.fallbackDone) {
        img.style.display = "none";
        return;
      }
      img.dataset.fallbackDone = "1";
      img.src = "logo.png";
    };
  })();

  const passed = getPassedCount();
  const totalGuess = parseInt(localStorage.getItem("pap_total_modules") || "0", 10) || 0;

  // ‚úÖ Primary unlock signal (set by academy.js)
  const allDone = (localStorage.getItem("papAcademyCompleted") === "1");

  if (!allDone) {
    document.getElementById("locked").style.display = "block";
    document.getElementById("lockStatus").innerText =
      tr("cert.locked.progress", "Progress: {passed} / {total} modules completed.", {
        passed,
        total: totalGuess ? totalGuess : "?"
      });
  } else {
    document.getElementById("cert").style.display = "block";

    const user = (typeof authGetUser === "function" ? authGetUser() : null) || {};
    const email = (user.email || "").toLowerCase().trim();

    // ‚úÖ Full name priority
    const fullName =
      (user.name && String(user.name).trim()) ||
      [user.given_name, user.family_name].filter(Boolean).join(" ").trim() ||
      (user.nickname && String(user.nickname).trim()) ||
      "Partner";

    // Stable-ish reference from email (no secrets)
    function refFromEmail(e) {
      let h = 0;
      for (let i = 0; i < e.length; i++) {
        h = ((h << 5) - h) + e.charCodeAt(i);
        h |= 0;
      }
      return String(Math.abs(h)).slice(0, 8).padStart(8, "0");
    }

    const dateStr = new Date().toISOString().slice(0, 10);
    const certId = `PAP-${dateStr.replaceAll("-","")}-${refFromEmail(email || "partner")}`;

    document.getElementById("partnerName").innerText = fullName;

    // ‚úÖ Avoid duplicate email line if name is already the email
    const emailEl = document.getElementById("partnerEmail");
    if (emailEl) {
      if (email && fullName.toLowerCase() !== email) {
        emailEl.style.display = "block";
        emailEl.innerText = email;
      } else {
        emailEl.style.display = "none";
      }
    }

    document.getElementById("certId").innerText =
      tr("cert.meta.id", "Certificate ID: {id}", { id: certId });

    document.getElementById("certDate").innerText =
      tr("cert.meta.issued", "Issued on: {date}", { date: dateStr });
  }
</script>

</body>
</html>

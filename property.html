<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title data-i18n="property.pageTitle">Property — PanAfric Properties</title>
  <meta name="description" content="Property details." />

  <!-- ✅ absolute favicon paths so they work on /properties/<id> -->
  <link rel="icon" href="/favicon.ico" sizes="any">
  <link rel="icon" type="image/png" href="/favicon.png">

  <link rel="stylesheet" href="styles.css">

  <style>
    /* Gallery: no stretch, consistent crop, responsive */
    #gallery{
      margin-top: 14px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px;
    }
    .papGalleryItem{
      position: relative;
      overflow: hidden;
      border-radius: 14px;
      background: rgba(0,0,0,.04);
      aspect-ratio: 16 / 10;
    }
    .papGalleryItem img{
      width: 100%;
      height: 100%;
      display: block;
      object-fit: cover;
      object-position: center;
    }

    .papMetaRow{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      justify-content:space-between;
      align-items:flex-start;
    }
    .papTitleBlock{ min-width:260px; flex:1; }
    #title{ line-height: 1.15; }
    #location{ margin: 6px 0 0; opacity: .85; }

    .papPriceBlock{ text-align:right; min-width:180px; }
    #price{ font-size: 1.25rem; font-weight: 800; }
    #badge{ opacity: .9; margin-top: 4px; font-weight: 700; }

    .papGrid{ margin-top:16px; display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 14px; }
    @media (max-width: 860px){
      .papGrid{ grid-template-columns: 1fr; }
      .papPriceBlock{ text-align:left; }
    }

    .papCardTitle{ margin: 0 0 10px; }

    /* Details list: nicer + compact */
    #detailsList{
      margin:0;
      display:grid;
      grid-template-columns: 1fr;
      gap: 8px;
      padding-left: 0;
      list-style: none;
    }
    #detailsList li{
      display:flex;
      justify-content:space-between;
      gap:12px;
      padding:10px 12px;
      border-radius: 12px;
      background: rgba(0,0,0,.03);
    }
    #detailsList li strong{ font-weight: 700; }
    #detailsList li span{ opacity: .9; }

    #description{ white-space: pre-wrap; line-height: 1.55; }

    /* Enquiry form */
    .papFormGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 860px){
      .papFormGrid{ grid-template-columns: 1fr; }
    }
    .papHoneypot{ display:none !important; }

    /* Status callout */
    .papStatusNote{
      margin: 0 0 12px;
      opacity: .9;
    }
  </style>
</head>

<body data-page="property">
  <header class="header">
    <div class="wrap">
      <div class="navbar">
        <a class="brand" href="index.html" style="text-decoration:none;">
          <strong>PanAfric Properties</strong>
        </a>

        <div class="lang" style="display:flex; gap:10px; align-items:center;">
          <label for="langSelect" class="small" data-i18n="lang_label">Language</label>
          <select id="langSelect" aria-label="Language">
            <option value="en">EN</option>
            <option value="fr">FR</option>
            <option value="es">ES</option>
          </select>
        </div>
      </div>
    </div>
  </header>

  <main>
    <section class="section">
      <div class="wrap">
        <a href="properties.html" class="small" style="text-decoration:none;" data-i18n="property.backLink">← Back to listings</a>

        <div id="errorState" class="card" style="padding:18px; margin-top:14px; display:none;">
          <h3 style="margin:0 0 6px;" data-i18n="property.notFoundTitle">Property not found</h3>
          <p class="small" id="errorText" style="margin:0;" data-i18n="property.notFoundText">
            This listing may have been removed or is not approved.
          </p>
          <div class="small" id="debugBox" style="margin-top:10px; opacity:.75; white-space:pre-wrap; display:none;"></div>
        </div>

        <div id="content" style="display:none;">
          <div class="card" style="padding:18px; margin-top:14px;">
            <div class="papMetaRow">
              <div class="papTitleBlock">
                <h1 id="title" style="margin:0;"></h1>
                <p id="location" class="small"></p>
              </div>
              <div class="papPriceBlock">
                <div id="price"></div>
                <div id="badge" class="small"></div>
              </div>
            </div>

            <div id="gallery"></div>
          </div>

          <div class="papGrid">
            <div class="card" style="padding:18px;">
              <h3 class="papCardTitle" data-i18n="property.detailsTitle">Details</h3>
              <ul class="list" id="detailsList"></ul>
            </div>

            <div class="card" style="padding:18px;">
              <h3 class="papCardTitle" data-i18n="property.descriptionTitle">Description</h3>
              <p class="small" id="description" style="margin:0;"></p>
            </div>

            <div class="card" style="padding:18px;">
              <h3 class="papCardTitle" data-i18n="property.featuresTitle">Features</h3>
              <ul class="list" id="featuresList" style="margin:0;"></ul>
            </div>

            <!-- ✅ PUBLIC CONTACT = PANAFRIC ONLY -->
            <div class="card" style="padding:18px;">
              <h3 class="papCardTitle" data-i18n="property.enquiryTitle">Contact PanAfric Properties</h3>

              <!-- Status-driven note (sold/under offer) -->
              <p class="small papStatusNote" id="statusNote" style="display:none;"></p>

              <p class="small" id="enquiryIntro" style="margin:0 0 12px; opacity:.85;" data-i18n="property.enquiryNote">
                Interested in this property? Send your enquiry here. Our team will contact you and connect you with the right partner.
              </p>

              <div id="soldBox" class="card" style="padding:14px; display:none;">
                <strong id="soldTitle">This property is sold.</strong>
                <div class="small" style="margin-top:6px; opacity:.9;" id="soldText">
                  You can request similar properties and our team will assist you.
                </div>
                <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
                  <a class="btn green" href="properties.html" id="soldBrowseBtn">Browse other properties</a>
                </div>
              </div>

              <form id="enquiryForm">
                <!-- honeypot anti-spam -->
                <div class="papHoneypot">
                  <label>Website <input type="text" name="website" autocomplete="off"></label>
                </div>

                <!-- hidden listing context -->
                <input type="hidden" name="listing_id" id="enq_listing_id">
                <input type="hidden" name="listing_title" id="enq_listing_title">
                <input type="hidden" name="listing_url" id="enq_listing_url">
                <input type="hidden" name="listing_status" id="enq_listing_status">

                <div class="papFormGrid">
                  <div>
                    <label class="small" for="buyer_name" data-i18n="property.enquiry.name">Full name</label>
                    <input class="input" id="buyer_name" name="buyer_name" type="text" required>
                  </div>
                  <div>
                    <label class="small" for="buyer_email" data-i18n="property.enquiry.email">Email</label>
                    <input class="input" id="buyer_email" name="buyer_email" type="email" required>
                  </div>
                </div>

                <div style="margin-top:10px;">
                  <label class="small" for="buyer_phone" data-i18n="property.enquiry.phone">Phone (optional)</label>
                  <input class="input" id="buyer_phone" name="buyer_phone" type="text">
                </div>

                <div style="margin-top:10px;">
                  <label class="small" for="message" data-i18n="property.enquiry.message">Message</label>
                  <textarea class="input" id="message" name="message" rows="5" required placeholder="Tell us what you need (budget, timeframe, viewing request)…"></textarea>
                </div>

                <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                  <button class="btn green" type="submit" id="enqSubmitBtn" data-i18n="property.enquiry.submit">Send enquiry</button>
                  <span id="enqSpinner" class="small" style="display:none; opacity:.8;" data-i18n="property.enquiry.sending">Sending…</span>
                </div>

                <div id="enqOk" class="card" style="margin-top:12px; padding:14px; display:none;"></div>
                <div id="enqErr" class="card" style="margin-top:12px; padding:14px; display:none;"></div>

                <p class="small" style="margin-top:10px; opacity:.75;" data-i18n="property.enquiry.confirmLine">
                  Thank you for the enquiry. PanAfric Properties will contact you shortly.
                </p>
              </form>
            </div>
          </div>

        </div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="wrap small">
      <span>© <span id="year"></span> PanAfric Properties</span>
    </div>
  </footer>

  <!-- Hidden translation labels for JS -->
  <div style="display:none;">
    <span id="lbl_id" data-i18n="property.details.id">ID</span>
    <span id="lbl_type" data-i18n="property.details.type">Type</span>
    <span id="lbl_category" data-i18n="property.details.category">Category</span>
    <span id="lbl_bedrooms" data-i18n="property.details.bedrooms">Bedrooms</span>
    <span id="lbl_bathrooms" data-i18n="property.details.bathrooms">Bathrooms</span>
    <span id="lbl_size" data-i18n="property.details.size">Size</span>
    <span id="lbl_yearBuilt" data-i18n="property.details.yearBuilt">Year built</span>
    <span id="lbl_city" data-i18n="property.details.city">City</span>
    <span id="lbl_country" data-i18n="property.details.country">Country</span>

    <!-- optional future i18n keys (fallbacks are in JS) -->
    <span id="lbl_status_sold" data-i18n="properties.badgeSold">Sold</span>
    <span id="lbl_status_under_offer" data-i18n="properties.badgeUnderOffer">Under offer</span>
  </div>

  <script src="/assets/js/i18n.js"></script>

  <script>
    (function(){
      document.getElementById('year').textContent = new Date().getFullYear();

      const langSelect = document.getElementById('langSelect');
      const saved = (localStorage.getItem('pap_lang') || localStorage.getItem('lang') || 'en').toLowerCase();
      if (['en','fr','es'].includes(saved)) langSelect.value = saved;

      function applyLang(lang){
        try {
          if (typeof papSetLang === 'function') papSetLang(lang);
          else localStorage.setItem('pap_lang', lang);
        } catch(e) {}
      }
      langSelect.addEventListener('change', () => applyLang(langSelect.value));
      applyLang(langSelect.value);
    })();
  </script>

  <script>
    (function(){
      const SUPABASE_URL = "https://ogyhfjdrqcupwesnjoly.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9neWhmamRycWN1cHdlc25qb2x5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzMzk3MzcsImV4cCI6MjA4NjkxNTczN30.rMf9nGeN2DxjSjzUAC4agcXEnsliiZWnTMOoV6qMsAo";
      const REST = `${SUPABASE_URL}/rest/v1/listings`;

      const headers = {
        "apikey": SUPABASE_ANON_KEY,
        "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
        "Accept": "application/json"
      };

      function getId(){
        const u = new URL(location.href);
        const qid = u.searchParams.get('id');
        if (qid) return qid;

        const path = location.pathname || '';
        const m = path.match(/\/properties\/([^\/?#]+)\/?$/);
        if (m && m[1]) return decodeURIComponent(m[1]);
        return '';
      }

      const id = getId();

      const errorState = document.getElementById('errorState');
      const errorText = document.getElementById('errorText');
      const debugBox = document.getElementById('debugBox');
      const content = document.getElementById('content');

      function showError(msg, debug){
        errorState.style.display = 'block';
        content.style.display = 'none';
        if (msg) errorText.textContent = msg;
        if (debug){
          debugBox.style.display = 'block';
          debugBox.textContent = debug;
        } else {
          debugBox.style.display = 'none';
          debugBox.textContent = '';
        }
      }

      function escapeHtml(str){
        return String(str ?? '').replace(/[&<>"']/g, s => ({
          '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
        }[s]));
      }

      function money(price, currency){
        const v = Number(price);
        if (!Number.isFinite(v)) return '';
        const c = (currency || 'EUR').toUpperCase();
        try {
          return new Intl.NumberFormat(undefined, { style:'currency', currency:c, maximumFractionDigits:0 }).format(v);
        } catch(e){
          return `${v.toLocaleString()} ${c}`;
        }
      }

      function li(labelId, value){
        if (value === undefined || value === null || value === '') return '';
        const label = document.getElementById(labelId)?.textContent || labelId;
        return `<li><strong>${escapeHtml(label)}:</strong> <span>${escapeHtml(value)}</span></li>`;
      }

      function parseImages(item){
        const v = item.images;
        if (Array.isArray(v)) return v;
        if (typeof v === 'string' && v.trim()){
          try {
            const arr = JSON.parse(v);
            if (Array.isArray(arr)) return arr;
          } catch(e){}
          return [v];
        }
        return [];
      }

      function parseFeatures(item){
        const v = item.features;
        if (Array.isArray(v)) return v;
        if (typeof v === 'string' && v.trim()){
          try {
            const arr = JSON.parse(v);
            if (Array.isArray(arr)) return arr.map(x => String(x)).filter(Boolean);
          } catch(e){}
          return v.split(',').map(s => s.trim()).filter(Boolean);
        }
        return [];
      }

      function normalizeStatus(st){
        return String(st || '').toLowerCase().trim();
      }

      // ✅ Visible statuses (so SOLD / UNDER OFFER still display)
      function isAllowedStatus(st){
        const s = normalizeStatus(st);
        return (s === 'approved' || s === 'published' || s === 'live' || s === 'sold' || s === 'under_offer' || s === '');
      }

      function getStatusLabel(status){
        const s = normalizeStatus(status);
        if (s === 'sold') return (document.getElementById('lbl_status_sold')?.textContent || 'Sold');
        if (s === 'under_offer') return (document.getElementById('lbl_status_under_offer')?.textContent || 'Under offer');
        return '';
      }

      function setEnquiryContext(listingId, title, status){
        const elId = document.getElementById('enq_listing_id');
        const elTitle = document.getElementById('enq_listing_title');
        const elUrl = document.getElementById('enq_listing_url');
        const elStatus = document.getElementById('enq_listing_status');
        if (elId) elId.value = listingId || '';
        if (elTitle) elTitle.value = title || '';
        if (elUrl) elUrl.value = location.href;
        if (elStatus) elStatus.value = status || '';
      }

      function applyStatusUI(item){
        const s = normalizeStatus(item.status);
        const statusLabel = getStatusLabel(s);

        // Badge: if sold/under_offer show status label, otherwise show rent/sale label
        const badge = document.getElementById('badge');
        if (badge){
          if (s === 'sold' || s === 'under_offer'){
            badge.textContent = statusLabel;
          } else {
            const cat = String(item.category || '').toLowerCase();
            const badgeLabel = cat === 'rent'
              ? (document.querySelector('[data-i18n="properties.badgeRent"]')?.textContent || 'For rent')
              : (document.querySelector('[data-i18n="properties.badgeSale"]')?.textContent || 'For sale');
            badge.textContent = badgeLabel;
          }
        }

        // Status note + form behavior
        const statusNote = document.getElementById('statusNote');
        const enquiryForm = document.getElementById('enquiryForm');
        const soldBox = document.getElementById('soldBox');
        const enquiryIntro = document.getElementById('enquiryIntro');

        if (s === 'sold') {
          if (statusNote){
            statusNote.style.display = 'block';
            statusNote.textContent = (statusLabel ? `${statusLabel}. ` : '') + 'This property is no longer available.';
          }
          if (soldBox) soldBox.style.display = 'block';
          if (enquiryIntro) enquiryIntro.style.display = 'none';
          if (enquiryForm) enquiryForm.style.display = 'none';
        } else if (s === 'under_offer') {
          if (statusNote){
            statusNote.style.display = 'block';
            statusNote.textContent = (statusLabel ? `${statusLabel}. ` : '') + 'You may still send an enquiry in case it becomes available.';
          }
          if (soldBox) soldBox.style.display = 'none';
          if (enquiryIntro) enquiryIntro.style.display = 'block';
          if (enquiryForm) enquiryForm.style.display = 'block';
        } else {
          if (statusNote) statusNote.style.display = 'none';
          if (soldBox) soldBox.style.display = 'none';
          if (enquiryIntro) enquiryIntro.style.display = 'block';
          if (enquiryForm) enquiryForm.style.display = 'block';
        }
      }

      async function load(){
        if (!id){
          showError("Missing listing id.");
          return;
        }

        const url = `${REST}?select=*&id=eq.${encodeURIComponent(id)}&limit=1`;

        let res, text;
        try {
          res = await fetch(url, { headers });
          text = await res.text();
        } catch (e){
          showError("Unable to load listing (network error).", String(e?.message || e));
          return;
        }

        if (!res.ok){
          console.error("Supabase error:", res.status, text);
          showError("Unable to load listing (Supabase error).", `HTTP ${res.status}\n${text}`);
          return;
        }

        let arr;
        try { arr = JSON.parse(text); } catch(e){ arr = null; }
        const item = Array.isArray(arr) ? arr[0] : null;

        if (!item){
          showError("Property not found.", `Query returned empty.\nID: ${id}`);
          return;
        }

        if (!isAllowedStatus(item.status)){
          showError("Property not found.", `Status not allowed: ${item.status}`);
          return;
        }

        const title = (item.title || item.listing_title || '').toString().trim() || 'Untitled';
        document.getElementById('title').textContent = title;
        document.getElementById('location').textContent = [item.city, item.country].filter(Boolean).join(', ');
        document.getElementById('price').textContent = money(item.price, item.currency);

        const gallery = document.getElementById('gallery');
        const imgs = parseImages(item);
        gallery.innerHTML = imgs.length
          ? imgs.map(src => `
              <div class="papGalleryItem">
                <img src="${escapeHtml(src)}" alt="${escapeHtml(title)}" loading="lazy">
              </div>
            `).join('')
          : `<div class="small" data-i18n="property.noImages">No images available</div>`;

        const details = document.getElementById('detailsList');
        const ptype = item.propertyType || item.property_type || item.type || '';

        const sizeM2 = item.size_m2 ?? item.sizeM2 ?? item.size_m ?? item.size ?? '';
        const sizeLabel = sizeM2 !== '' ? `${sizeM2} m²` : '';

        details.innerHTML = [
          li('lbl_id', item.id),
          li('lbl_type', ptype),
          li('lbl_category', item.category),
          li('lbl_bedrooms', item.bedrooms),
          li('lbl_bathrooms', item.bathrooms),
          li('lbl_size', sizeLabel),
          li('lbl_yearBuilt', item.yearBuilt),
          li('lbl_city', item.city),
          li('lbl_country', item.country)
        ].filter(Boolean).join('');

        document.getElementById('description').textContent = item.description || '';

        const feats = parseFeatures(item);
        const features = document.getElementById('featuresList');
        features.innerHTML = feats.length
          ? feats.map(f => `<li>${escapeHtml(f)}</li>`).join('')
          : `<li data-i18n="property.noFeatures">No features listed</li>`;

        // ✅ store listing context + status in enquiry payload
        setEnquiryContext(item.id, title, normalizeStatus(item.status));

        // ✅ apply SOLD / UNDER OFFER behaviors
        applyStatusUI(item);

        errorState.style.display = 'none';
        content.style.display = 'block';

        try {
          if (typeof papReapplyI18n === 'function') { papReapplyI18n(); setTimeout(papReapplyI18n, 0); }
          else if (typeof papApplyI18n === 'function') { papApplyI18n(); setTimeout(papApplyI18n, 0); }
        } catch(e){}
      }

      load();
    })();
  </script>

  <script>
    (function(){
      const form = document.getElementById('enquiryForm');
      if (!form) return;

      const btn = document.getElementById('enqSubmitBtn');
      const sp = document.getElementById('enqSpinner');
      const ok = document.getElementById('enqOk');
      const err = document.getElementById('enqErr');

      function showOk(html){
        if (err) err.style.display = 'none';
        if (ok){
          ok.style.display = 'block';
          ok.innerHTML = html;
        }
      }
      function showErr(text){
        if (ok) ok.style.display = 'none';
        if (err){
          err.style.display = 'block';
          err.textContent = text || 'Something went wrong.';
        }
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (ok) ok.style.display = 'none';
        if (err) err.style.display = 'none';

        // honeypot
        const hp = (form.querySelector('input[name="website"]')?.value || '').trim();
        if (hp) {
          showOk('<strong>Thank you.</strong>');
          return;
        }

        if (!form.checkValidity()){
          form.reportValidity();
          return;
        }

        if (btn) btn.disabled = true;
        if (sp) sp.style.display = 'inline';

        try{
          const payload = {
            listing_id: (document.getElementById('enq_listing_id')?.value || '').trim(),
            listing_title: (document.getElementById('enq_listing_title')?.value || '').trim(),
            listing_url: (document.getElementById('enq_listing_url')?.value || '').trim(),
            listing_status: (document.getElementById('enq_listing_status')?.value || '').trim(),

            buyer_name: (form.querySelector('[name="buyer_name"]')?.value || '').trim(),
            buyer_email: (form.querySelector('[name="buyer_email"]')?.value || '').trim(),
            buyer_phone: (form.querySelector('[name="buyer_phone"]')?.value || '').trim(),
            message: (form.querySelector('[name="message"]')?.value || '').trim(),

            lang: (localStorage.getItem('pap_lang') || localStorage.getItem('lang') || 'en').toLowerCase(),
            page: location.pathname
          };

          const res = await fetch('/.netlify/functions/submitEnquiry', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          const data = await res.json().catch(() => ({}));
          if (!res.ok || data.ok === false) {
            throw new Error(data.error || `Enquiry failed (${res.status})`);
          }

          form.reset();

          // ✅ Your preferred premium message
          showOk('<strong>Thank you for the enquiry.</strong><br><span class="small">PanAfric Properties will contact you shortly.</span>');

          try {
            if (typeof papReapplyI18n === 'function') { papReapplyI18n(); setTimeout(papReapplyI18n, 0); }
            else if (typeof papApplyI18n === 'function') { papApplyI18n(); setTimeout(papApplyI18n, 0); }
          } catch(e){}

        } catch(ex){
          showErr(ex?.message || 'Enquiry failed.');
        } finally {
          if (btn) btn.disabled = false;
          if (sp) sp.style.display = 'none';
        }
      });
    })();
  </script>
</body>
</html>

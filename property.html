<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title data-i18n="property.pageTitle">Property — PanAfric Properties</title>
  <meta name="description" content="Property details." />

  <link rel="icon" href="favicon.ico" sizes="any">
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="stylesheet" href="styles.css">
</head>

<body data-page="property">
  <header class="header">
    <div class="wrap">
      <div class="navbar">
        <a class="brand" href="index.html" style="text-decoration:none;">
          <strong>PanAfric Properties</strong>
        </a>

        <div class="lang" style="display:flex; gap:10px; align-items:center;">
          <label for="langSelect" class="small" data-i18n="lang_label">Language</label>
          <select id="langSelect" aria-label="Language">
            <option value="en">EN</option>
            <option value="fr">FR</option>
            <option value="es">ES</option>
          </select>
        </div>
      </div>
    </div>
  </header>

  <main>
    <section class="section">
      <div class="wrap">
        <a href="properties.html" class="small" style="text-decoration:none;" data-i18n="property.backLink">← Back to listings</a>

        <div id="errorState" class="card" style="padding:18px; margin-top:14px; display:none;">
          <h3 style="margin:0 0 6px;" data-i18n="property.notFoundTitle">Property not found</h3>
          <p class="small" style="margin:0;" data-i18n="property.notFoundText">
            This listing may have been removed or is not approved.
          </p>
        </div>

        <div id="content" style="display:none;">
          <div class="card" style="padding:18px; margin-top:14px;">
            <div style="display:flex; flex-wrap:wrap; gap:12px; justify-content:space-between; align-items:flex-start;">
              <div style="min-width:260px; flex:1;">
                <h1 id="title" style="margin:0;"></h1>
                <p id="location" class="small" style="margin:6px 0 0;"></p>
              </div>
              <div style="text-align:right;">
                <div id="price" style="font-size:1.2rem; font-weight:700;"></div>
                <div id="badge" class="small" style="opacity:.9; margin-top:4px;"></div>
              </div>
            </div>

            <div id="gallery" style="margin-top:14px; display:grid; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); gap:10px;"></div>
          </div>

          <div class="grid" style="margin-top:16px;">
            <div class="card" style="padding:18px;">
              <h3 style="margin:0 0 10px;" data-i18n="property.detailsTitle">Details</h3>
              <ul class="list" id="detailsList" style="margin:0;"></ul>
            </div>

            <div class="card" style="padding:18px;">
              <h3 style="margin:0 0 10px;" data-i18n="property.descriptionTitle">Description</h3>
              <p class="small" id="description" style="margin:0;"></p>
            </div>

            <div class="card" style="padding:18px;">
              <h3 style="margin:0 0 10px;" data-i18n="property.featuresTitle">Features</h3>
              <ul class="list" id="featuresList" style="margin:0;"></ul>
            </div>

            <div class="card" style="padding:18px;">
              <h3 style="margin:0 0 10px;" data-i18n="property.contactTitle">Contact</h3>
              <div class="small" id="contactBox"></div>
              <div style="margin-top:12px; display:flex; flex-wrap:wrap; gap:10px;">
                <a id="emailBtn" class="btn" href="#" data-i18n="property.emailBtn">Email</a>
                <a id="waBtn" class="btn" href="#" target="_blank" rel="noopener" data-i18n="property.whatsappBtn">WhatsApp</a>
              </div>
            </div>
          </div>

        </div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="wrap small">
      <span>© <span id="year"></span> PanAfric Properties</span>
    </div>
  </footer>

  <script src="/assets/js/i18n.js"></script>  <script>
    (function(){
      document.getElementById('year').textContent = new Date().getFullYear();

      const langSelect = document.getElementById('langSelect');
      const saved = (localStorage.getItem('pap_lang') || localStorage.getItem('lang') || 'en').toLowerCase();
      if (['en','fr','es'].includes(saved)) langSelect.value = saved;

      function applyLang(lang){
        try {
          if (typeof papSetLang === 'function') papSetLang(lang);
          else localStorage.setItem('pap_lang', lang);
        } catch(e) {}
      }
      langSelect.addEventListener('change', () => applyLang(langSelect.value));
      applyLang(langSelect.value);
    })();
  </script>

  <script>
    (function(){
      // ✅ Supabase public config (anon only; never use service role in browser)
      const SUPABASE_URL = "https://ogyhfjdrqcupwesnjoly.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9neWhmamRycWN1cHdlc25qb2x5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzMzk3MzcsImV4cCI6MjA4NjkxNTczN30.rMf9nGeN2DxjSjzUAC4agcXEnsliiZWnTMOoV6qMsAo";
      const REST = `${SUPABASE_URL}/rest/v1/listings`;
      const headers = {
        "apikey": SUPABASE_ANON_KEY,
        "Authorization": `Bearer ${SUPABASE_ANON_KEY}`
      };

      function getId(){
        // Supports:
        // 1) Clean URL: /properties/<id>  (recommended)
        // 2) Query: property.html?id=<id> (fallback)
        const u = new URL(location.href);
        const qid = u.searchParams.get('id');
        if (qid) return qid;

        const path = location.pathname || '';
        const m = path.match(/\/properties\/([^\/?#]+)\/?$/);
        if (m && m[1]) return decodeURIComponent(m[1]);
        return '';
      }

      const id = getId();

      const errorState = document.getElementById('errorState');
      const content = document.getElementById('content');

      function escapeHtml(str){
        return String(str ?? '').replace(/[&<>"']/g, s => ({
          '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
        }[s]));
      }

      function money(price, currency){
        const v = Number(price);
        if (!Number.isFinite(v)) return '';
        const c = (currency || 'EUR').toUpperCase();
        try {
          return new Intl.NumberFormat(undefined, { style:'currency', currency:c, maximumFractionDigits:0 }).format(v);
        } catch(e){
          return `${v.toLocaleString()} ${c}`;
        }
      }

      function li(labelKey, value){
        if (value === undefined || value === null || value === '') return '';
        const label = document.querySelector(`[data-i18n="${labelKey}"]`)?.textContent || labelKey;
        return `<li><strong>${escapeHtml(label)}:</strong> ${escapeHtml(value)}</li>`;
      }

      function parseImages(item){
        // Supports images stored as array, JSON string array, or a single URL string
        const v = item.images;
        if (Array.isArray(v)) return v;
        if (typeof v === 'string' && v.trim()){
          try {
            const arr = JSON.parse(v);
            if (Array.isArray(arr)) return arr;
          } catch(e){}
          return [v];
        }
        return [];
      }

      function isAllowedStatus(st){
        const s = String(st || '').toLowerCase().trim();
        // Allow both "approved" and "published" (depending how your function writes status)
        return (s === 'approved' || s === 'published' || s === 'live' || s === '');
      }

      async function load(){
        try{
          // Adjust select list to match your Supabase schema (safe to include extra columns)
          const select = [
            "id","title","listing_title",
            "status","category",
            "type","propertyType","property_type",
            "country","city","price","currency",
            "bedrooms","bathrooms","sizeM2","yearBuilt",
            "description","features","images","cover_url",
            "contact","contact_name","contact_email","contact_phone","contact_whatsapp",
            "created_at"
          ].join(',');

          const url = `${REST}?select=${encodeURIComponent(select)}&id=eq.${encodeURIComponent(id)}&limit=1`;

          const res = await fetch(url, { headers });
          if (!res.ok) throw new Error('HTTP ' + res.status);

          const arr = await res.json();
          const item = Array.isArray(arr) ? arr[0] : null;

          if (!item || !isAllowedStatus(item.status)){
            errorState.style.display = 'block';
            content.style.display = 'none';
            return;
          }

          // Title + location + price
          const title = item.title || item.listing_title || '';
          document.getElementById('title').textContent = title;
          document.getElementById('location').textContent = [item.city, item.country].filter(Boolean).join(', ');
          document.getElementById('price').textContent = money(item.price, item.currency);

          const badge = (item.category || '').toLowerCase();
          const badgeLabel = badge === 'rent'
            ? (document.querySelector('[data-i18n="properties.badgeRent"]')?.textContent || 'For rent')
            : (document.querySelector('[data-i18n="properties.badgeSale"]')?.textContent || 'For sale');
          document.getElementById('badge').textContent = badgeLabel;

          // Gallery
          const gallery = document.getElementById('gallery');
          const imgs = parseImages(item);
          gallery.innerHTML = imgs.length
            ? imgs.map(src => `<img src="${escapeHtml(src)}" alt="${escapeHtml(title)}" style="width:100%; height:220px; object-fit:cover; border-radius:14px; display:block;">`).join('')
            : `<div class="small" data-i18n="property.noImages">No images available</div>`;

          // Details list (support multiple column names)
          const details = document.getElementById('detailsList');
          const ptype = item.propertyType || item.property_type || item.type || '';
          details.innerHTML = [
            li('property.details.id', item.id),
            li('property.details.type', ptype),
            li('property.details.category', item.category),
            li('property.details.bedrooms', item.bedrooms ?? item.bedrooms),
            li('property.details.bathrooms', item.bathrooms ?? item.bathrooms),
            li('property.details.size', item.sizeM2 ? `${item.sizeM2} m²` : ''),
            li('property.details.yearBuilt', item.yearBuilt),
            li('property.details.city', item.city),
            li('property.details.country', item.country)
          ].filter(Boolean).join('');

          // Description + features
          document.getElementById('description').textContent = item.description || '';
          const features = document.getElementById('featuresList');
          const feats = Array.isArray(item.features) ? item.features : (typeof item.features === 'string' && item.features.trim() ? item.features.split(',').map(s => s.trim()).filter(Boolean) : []);
          features.innerHTML = feats.length ? feats.map(f => `<li>${escapeHtml(f)}</li>`).join('') : `<li data-i18n="property.noFeatures">No features listed</li>`;

          // Contact (supports contact JSON OR flat columns)
          const c = item.contact || {
            name: item.contact_name,
            email: item.contact_email,
            phone: item.contact_phone,
            whatsapp: item.contact_whatsapp
          } || {};

          const contactBox = document.getElementById('contactBox');
          contactBox.innerHTML = `
            <div><strong>${escapeHtml(c.name || 'PanAfric Properties')}</strong></div>
            ${c.email ? `<div>${escapeHtml(c.email)}</div>` : ''}
            ${c.phone ? `<div>${escapeHtml(c.phone)}</div>` : ''}
          `;

          const emailBtn = document.getElementById('emailBtn');
          emailBtn.href = c.email
            ? `mailto:${encodeURIComponent(c.email)}?subject=${encodeURIComponent('Property enquiry: ' + (title || item.id))}`
            : '#';
          emailBtn.style.pointerEvents = c.email ? 'auto' : 'none';
          emailBtn.style.opacity = c.email ? '1' : '.5';

          const waBtn = document.getElementById('waBtn');

          // Prefer whatsapp, fallback to phone if whatsapp missing
          const waRaw = String(c.whatsapp || c.phone || '').trim();

          // Keep only digits and + sign
          let wa = waRaw.replace(/[^\d+]/g, '');

          // Remove ONLY the leading +
          const waDigits = wa.replace(/^\+/, '');

          waBtn.href = waDigits
            ? `https://wa.me/${encodeURIComponent(waDigits)}?text=${encodeURIComponent('Hello, I am interested in: ' + (title || item.id))}`
            : '#';

          waBtn.style.pointerEvents = waDigits ? 'auto' : 'none';
          waBtn.style.opacity = waDigits ? '1' : '.5';

          // Show content
          errorState.style.display = 'none';
          content.style.display = 'block';

          // Re-apply i18n after dynamic render
          try {
            if (typeof papReapplyI18n === 'function') {
              papReapplyI18n();
              setTimeout(papReapplyI18n, 0);
            } else if (typeof papApplyI18n === 'function') {
              papApplyI18n();
              setTimeout(papApplyI18n, 0);
            }
          } catch(e){}

        } catch(e){
          console.error(e);
          errorState.style.display = 'block';
          content.style.display = 'none';
        }
      }

      if (!id){
        errorState.style.display = 'block';
        content.style.display = 'none';
      } else {
        load();
      }
    })();
  </script>
</body>
</html>

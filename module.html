<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Training Module ‚Äî PanAfric Properties</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css">
</head>
<body>

<!-- ‚úÖ AUTH0 GUARD (paste right after <body>) -->
<script src="https://cdn.auth0.com/js/auth0/9.23/auth0.min.js"></script>
<script src="auth.js"></script>
<script>
  authHandleRedirect(function () {
    authRequireLogin();
  });
</script>

<!-- üåç Language Dropdown -->
<div class="lang-switch">
  <span class="lang-label" data-i18n="lang_label">Language</span>
  <select class="lang-select" aria-label="Language" onchange="papSetLang(this.value)">
    <option value="en">EN</option>
    <option value="fr">FR</option>
    <option value="es">ES</option>
  </select>
</div>

<!-- ‚úÖ i18n (load before we build dynamic strings so papT() is available if you have it) -->
<script src="/assets/js/i18n.js"></script>
<!-- ‚úÖ Module content data -->
<script src="modules.js"></script>
<script>
  function waitForLangReady(cb) {
    if (typeof window.papT === "function" && typeof window.papGetLang === "function") {
      cb();
    } else {
      setTimeout(() => waitForLangReady(cb), 50);
    }
  }
</script>

  
<section class="section">
  <div class="wrap">
    <a class="btn ghost" href="academy.html" data-i18n="academy_back">‚Üê Back to Academy</a>

    <div class="card" style="padding:22px 18px; margin-top:12px;">
      <h2 id="title"></h2>
      <div id="reading"></div>

      <hr style="margin:18px 0; opacity:.2;">

      <h3 data-i18n="module_quick_test_title">Quick Test</h3>
      <p class="small" data-i18n="module_quick_test_help">Answer all questions correctly to complete this module.</p>

      <form id="quizForm" onsubmit="return submitQuiz()"></form>

      <p class="small" id="msg" style="margin-top:12px;"></p>

      <div style="margin-top:14px;">
        <button class="btn ghost" type="button" onclick="authLogout()" data-i18n="logout_btn">Log out</button>
      </div>
    </div>
  </div>
</section>

<script>
  // Optional translator helper:
  // If your i18n.js provides papT(key) or t(key), we‚Äôll use it.
  // If not, we always fall back to the original English text.
  function _t(key, fallback) {
    try {
      if (typeof window.papT === "function") return window.papT(key) || fallback;
      if (typeof window.t === "function") return window.t(key) || fallback;
    } catch (e) {}
    return fallback;
  }

  // ‚úÖ Fallback progress marker (only used if academy.js used to define it)
  if (typeof window.papMarkModulePassed !== "function") {
    window.papMarkModulePassed = function (moduleId) {
      try {
        const key = "pap_modules_passed";
        const arr = JSON.parse(localStorage.getItem(key) || "[]");
        if (!arr.includes(moduleId)) arr.push(moduleId);
        localStorage.setItem(key, JSON.stringify(arr));
      } catch (e) {}
    };
  }

  const params = new URLSearchParams(window.location.search);
  const moduleId = parseInt(params.get("m") || "1", 10);

  // If MODULES isn‚Äôt available, go back (prevents blank module page).
  if (!window.MODULES || !Array.isArray(window.MODULES)) {
    window.location.href = "academy.html";
  }

  const mod = MODULES.find(x => x.id === moduleId);
  if (!mod) window.location.href = "academy.html";

  // Dynamic title with translatable "Module" label (English unchanged as fallback)
  const moduleWord = _t("module_word", "Module");
  const moduleTitle = (mod.titleKey ? _t(mod.titleKey, mod.title) : mod.title);
document.getElementById("title").innerText = `${moduleWord} ${mod.id} ‚Äî ${moduleTitle}`;


// Reading blocks (use readingKeys for translation, fallback to English)
const reading = document.getElementById("reading");
reading.innerHTML = "";

(mod.reading || []).forEach((p, idx) => {
  const el = document.createElement("p");
  el.className = "small";

  const key = (mod.readingKeys && mod.readingKeys[idx]) ? mod.readingKeys[idx] : null;
  el.innerText = key ? _t(key, p) : p;

  reading.appendChild(el);
});

// Quiz
const quizForm = document.getElementById("quizForm");
const selectText = _t("select_option", "Select");

(mod.quiz || []).forEach((item, idx) => {
  const block = document.createElement("div");
  block.style.marginTop = "12px";
  block.innerHTML = `
  <label style="display:block; margin-bottom:6px;">
    ${idx + 1}. ${(item.qKey ? _t(item.qKey, item.q) : item.q)}
  </label>
  <select id="q${idx}" required>
    <option value="">${selectText}</option>
    ${(item.options || []).map((opt, i) => {
      const ok = (item.optionKeys && item.optionKeys[i]) ? item.optionKeys[i] : null;
      const optText = ok ? _t(ok, opt) : opt;
      return `<option value="${i}">${optText}</option>`;
    }).join("")}
  </select>
`;

  quizForm.appendChild(block);
});


  const submitBtnText = _t("submit_test_btn", "Submit Test");
  quizForm.insertAdjacentHTML("beforeend", `
    <div style="margin-top:14px;">
      <button class="btn green" type="submit">${submitBtnText}</button>
    </div>
  `);

  function submitQuiz() {
    let correct = 0;
    (mod.quiz || []).forEach((item, idx) => {
      const v = document.getElementById(`q${idx}`).value;
      if (String(item.answerIndex) === String(v)) correct++;
    });

    if (correct === (mod.quiz || []).length) {
      papMarkModulePassed(mod.id);
      document.getElementById("msg").style.color = "green";
      document.getElementById("msg").innerText =
        _t("module_pass_msg", "‚úÖ Test passed. Module completed. Return to Academy to continue.");
    } else {
      document.getElementById("msg").style.color = "#b00020";
      const template = _t("module_fail_msg", "‚ùå Not yet. You got {correct}/{total}. Please review and try again.");
      document.getElementById("msg").innerText =
        template.replace("{correct}", String(correct)).replace("{total}", String((mod.quiz || []).length));
    }
    return false;
  }
</script>

</body>
</html>
